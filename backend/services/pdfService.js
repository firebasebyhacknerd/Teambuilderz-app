const puppeteer = require('puppeteer');\nconst fs = require('fs');\nconst path = require('path');\n\nclass PDFService {\n  constructor() {\n    this.browser = null;\n  }\n\n  async initializeBrowser() {\n    if (!this.browser) {\n      this.browser = await puppeteer.launch({\n        headless: 'new',\n        args: [\n          '--no-sandbox',\n          '--disable-setuid-sandbox',\n          '--disable-dev-shm-usage',\n          '--disable-accelerated-2d-canvas',\n          '--no-first-run',\n          '--no-zygote',\n          '--single-process',\n          '--disable-gpu'\n        ]\n      });\n    }\n    return this.browser;\n  }\n\n  async closeBrowser() {\n    if (this.browser) {\n      await this.browser.close();\n      this.browser = null;\n    }\n  }\n\n  async generatePDFReport(data, reportType, options = {}) {\n    const browser = await this.initializeBrowser();\n    const page = await browser.newPage();\n\n    try {\n      const html = await this.generateHTML(data, reportType, options);\n      await page.setContent(html, { waitUntil: 'networkidle0' });\n\n      const pdfBuffer = await page.pdf({\n        format: 'A4',\n        printBackground: true,\n        margin: {\n          top: '20mm',\n          right: '20mm',\n          bottom: '20mm',\n          left: '20mm'\n        },\n        ...options\n      });\n\n      return pdfBuffer;\n    } finally {\n      await page.close();\n    }\n  }\n\n  async generateHTML(data, reportType, options) {\n    const templates = {\n      attendance: this.generateAttendanceHTML,\n      candidates: this.generateCandidatesHTML,\n      performance: this.generatePerformanceHTML,\n      applications: this.generateApplicationsHTML,\n      interviews: this.generateInterviewsHTML,\n      general: this.generateGeneralHTML\n    };\n\n    const template = templates[reportType] || templates.general;\n    return template.call(this, data, options);\n  }\n\n  generateAttendanceHTML(data, options) {\n    const { dateFrom, dateTo, records = [] } = data;\n    const totalRecords = records.length;\n    const presentCount = records.filter(r => r.status === 'present').length;\n    const absentCount = records.filter(r => r.status === 'absent').length;\n    const leaveCount = records.filter(r => r.status === 'leave').length;\n\n    return `\n      <!DOCTYPE html>\n      <html>\n      <head>\n        <meta charset=\"utf-8\">\n        <title>Attendance Report</title>\n        <style>\n          body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; color: #333; }\n          .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #2563eb; padding-bottom: 20px; }\n          .header h1 { color: #2563eb; margin: 0; font-size: 28px; }\n          .header p { color: #666; margin: 5px 0; }\n          .summary { display: flex; justify-content: space-around; margin-bottom: 30px; }\n          .summary-card { background: #f8fafc; padding: 15px; border-radius: 8px; text-align: center; min-width: 120px; }\n          .summary-card h3 { margin: 0; color: #2563eb; font-size: 24px; }\n          .summary-card p { margin: 5px 0; color: #666; }\n          table { width: 100%; border-collapse: collapse; margin-top: 20px; }\n          th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e5e7eb; }\n          th { background: #f3f4f6; font-weight: 600; color: #374151; }\n          .status-present { color: #059669; font-weight: 600; }\n          .status-absent { color: #dc2626; font-weight: 600; }\n          .status-leave { color: #d97706; font-weight: 600; }\n          .footer { margin-top: 40px; text-align: center; color: #666; font-size: 12px; }\n        </style>\n      </head>\n      <body>\n        <div class=\"header\">\n          <h1>Attendance Report</h1>\n          <p>TeamBuilderz LLC - Internal Report</p>\n          <p>Period: ${dateFrom || 'All Time'} to ${dateTo || 'Present'}</p>\n          <p>Generated: ${new Date().toLocaleString()}</p>\n        </div>\n\n        <div class=\"summary\">\n          <div class=\"summary-card\">\n            <h3>${totalRecords}</h3>\n            <p>Total Records</p>\n          </div>\n          <div class=\"summary-card\">\n            <h3>${presentCount}</h3>\n            <p>Present</p>\n          </div>\n          <div class=\"summary-card\">\n            <h3>${absentCount}</h3>\n            <p>Absent</p>\n          </div>\n          <div class=\"summary-card\">\n            <h3>${leaveCount}</h3>\n            <p>On Leave</p>\n          </div>\n        </div>\n\n        <table>\n          <thead>\n            <tr>\n              <th>Date</th>\n              <th>Employee Name</th>\n              <th>Status</th>\n              <th>Check In</th>\n              <th>Check Out</th>\n              <th>Notes</th>\n            </tr>\n          </thead>\n          <tbody>\n            ${records.map(record => `\n              <tr>\n                <td>${record.attendance_date || 'N/A'}</td>\n                <td>${record.user_name || 'N/A'}</td>\n                <td class=\"status-${record.status}\">${record.status ? record.status.charAt(0).toUpperCase() + record.status.slice(1) : 'N/A'}</td>\n                <td>${record.check_in_time || 'N/A'}</td>\n                <td>${record.check_out_time || 'N/A'}</td>\n                <td>${record.notes || '-'}</td>\n              </tr>\n            `).join('')}\n          </tbody>\n        </table>\n\n        <div class=\"footer\">\n          <p>This report was generated automatically by TeamBuilderz System</p>\n          <p>Page ${options.pageNumber || 1} of ${options.totalPages || 1}</p>\n        </div>\n      </body>\n      </html>\n    `;\n  }\n\n  generateCandidatesHTML(data, options) {\n    const { candidates = [], filters = {} } = data;\n    const totalCandidates = candidates.length;\n    const stageGroups = candidates.reduce((acc, candidate) => {\n      acc[candidate.stage] = (acc[candidate.stage] || 0) + 1;\n      return acc;\n    }, {});\n\n    return `\n      <!DOCTYPE html>\n      <html>\n      <head>\n        <meta charset=\"utf-8\">\n        <title>Candidates Pipeline Report</title>\n        <style>\n          body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; color: #333; }\n          .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #2563eb; padding-bottom: 20px; }\n          .header h1 { color: #2563eb; margin: 0; font-size: 28px; }\n          .pipeline { display: flex; justify-content: space-around; margin-bottom: 30px; }\n          .stage { background: #f8fafc; padding: 15px; border-radius: 8px; text-align: center; min-width: 100px; }\n          .stage h3 { margin: 0; color: #2563eb; font-size: 20px; }\n          .stage p { margin: 5px 0; color: #666; font-size: 12px; }\n          table { width: 100%; border-collapse: collapse; margin-top: 20px; }\n          th, td { padding: 10px; text-align: left; border-bottom: 1px solid #e5e7eb; font-size: 12px; }\n          th { background: #f3f4f6; font-weight: 600; color: #374151; }\n          .stage-onboarding { color: #3b82f6; }\n          .stage-marketing { color: #10b981; }\n          .stage-interviewing { color: #f59e0b; }\n          .stage-offered { color: #8b5cf6; }\n          .stage-placed { color: #059669; }\n          .footer { margin-top: 40px; text-align: center; color: #666; font-size: 12px; }\n        </style>\n      </head>\n      <body>\n        <div class=\"header\">\n          <h1>Candidates Pipeline Report</h1>\n          <p>TeamBuilderz LLC - Recruitment Pipeline</p>\n          <p>Generated: ${new Date().toLocaleString()}</p>\n        </div>\n\n        <div class=\"pipeline\">\n          <div class=\"stage\">\n            <h3>${stageGroups.onboarding || 0}</h3>\n            <p>Onboarding</p>\n          </div>\n          <div class=\"stage\">\n            <h3>${stageGroups.marketing || 0}</h3>\n            <p>Marketing</p>\n          </div>\n          <div class=\"stage\">\n            <h3>${stageGroups.interviewing || 0}</h3>\n            <p>Interviewing</p>\n          </div>\n          <div class=\"stage\">\n            <h3>${stageGroups.offered || 0}</h3>\n            <p>Offered</p>\n          </div>\n          <div class=\"stage\">\n            <h3>${stageGroups.placed || 0}</h3>\n            <p>Placed</p>\n          </div>\n        </div>\n\n        <table>\n          <thead>\n            <tr>\n              <th>Name</th>\n              <th>Email</th>\n              <th>Phone</th>\n              <th>Stage</th>\n              <th>Skills</th>\n              <th>Recruiter</th>\n              <th>Added Date</th>\n            </tr>\n          </thead>\n          <tbody>\n            ${candidates.map(candidate => `\n              <tr>\n                <td>${candidate.name || 'N/A'}</td>\n                <td>${candidate.email || 'N/A'}</td>\n                <td>${candidate.phone || 'N/A'}</td>\n                <td class=\"stage-${candidate.stage}\">${candidate.stage ? candidate.stage.charAt(0).toUpperCase() + candidate.stage.slice(1) : 'N/A'}</td>\n                <td>${candidate.skills ? candidate.skills.join(', ') : 'N/A'}</td>\n                <td>${candidate.recruiter_name || 'N/A'}</td>\n                <td>${candidate.created_at ? new Date(candidate.created_at).toLocaleDateString() : 'N/A'}</td>\n              </tr>\n            `).join('')}\n          </tbody>\n        </table>\n\n        <div class=\"footer\">\n          <p>Total Candidates: ${totalCandidates} | This report was generated automatically by TeamBuilderz System</p>\n        </div>\n      </body>\n      </html>\n    `;\n  }\n\n  generatePerformanceHTML(data, options) {\n    const { recruiters = [], period = 'Monthly' } = data;\n    \n    return `\n      <!DOCTYPE html>\n      <html>\n      <head>\n        <meta charset=\"utf-8\">\n        <title>Performance Report</title>\n        <style>\n          body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; color: #333; }\n          .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #2563eb; padding-bottom: 20px; }\n          .header h1 { color: #2563eb; margin: 0; font-size: 28px; }\n          .metrics { display: flex; justify-content: space-around; margin-bottom: 30px; }\n          .metric { background: #f8fafc; padding: 20px; border-radius: 8px; text-align: center; min-width: 150px; }\n          .metric h3 { margin: 0; color: #2563eb; font-size: 24px; }\n          .metric p { margin: 5px 0; color: #666; }\n          table { width: 100%; border-collapse: collapse; margin-top: 20px; }\n          th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e5e7eb; }\n          th { background: #f3f4f6; font-weight: 600; color: #374151; }\n          .performance-excellent { color: #059669; font-weight: 600; }\n          .performance-good { color: #3b82f6; font-weight: 600; }\n          .performance-average { color: #f59e0b; font-weight: 600; }\n          .performance-poor { color: #dc2626; font-weight: 600; }\n          .footer { margin-top: 40px; text-align: center; color: #666; font-size: 12px; }\n        </style>\n      </head>\n      <body>\n        <div class=\"header\">\n          <h1>Recruiter Performance Report</h1>\n          <p>TeamBuilderz LLC - Performance Analytics</p>\n          <p>Period: ${period} | Generated: ${new Date().toLocaleString()}</p>\n        </div>\n\n        <div class=\"metrics\">\n          <div class=\"metric\">\n            <h3>${recruiters.length}</h3>\n            <p>Total Recruiters</p>\n          </div>\n          <div class=\"metric\">\n            <h3>${recruiters.reduce((sum, r) => sum + (r.applications || 0), 0)}</h3>\n            <p>Total Applications</p>\n          </div>\n          <div class=\"metric\">\n            <h3>${recruiters.reduce((sum, r) => sum + (r.interviews || 0), 0)}</h3>\n            <p>Total Interviews</p>\n          </div>\n          <div class=\"metric\">\n            <h3>${recruiters.reduce((sum, r) => sum + (r.placements || 0), 0)}</h3>\n            <p>Total Placements</p>\n          </div>\n        </div>\n\n        <table>\n          <thead>\n            <tr>\n              <th>Recruiter Name</th>\n              <th>Applications</th>\n              <th>Interviews</th>\n              <th>Placements</th>\n              <th>Conversion Rate</th>\n              <th>Performance</th>\n            </tr>\n          </thead>\n          <tbody>\n            ${recruiters.map(recruiter => {\n              const conversionRate = recruiter.applications > 0 \n                ? ((recruiter.placements / recruiter.applications) * 100).toFixed(1)\n                : '0.0';\n              const performance = recruiter.placements >= 5 ? 'excellent' :\n                               recruiter.placements >= 3 ? 'good' :\n                               recruiter.placements >= 1 ? 'average' : 'poor';\n              \n              return `\n              <tr>\n                <td>${recruiter.name || 'N/A'}</td>\n                <td>${recruiter.applications || 0}</td>\n                <td>${recruiter.interviews || 0}</td>\n                <td>${recruiter.placements || 0}</td>\n                <td>${conversionRate}%</td>\n                <td class=\"performance-${performance}\">${performance.charAt(0).toUpperCase() + performance.slice(1)}</td>\n              </tr>\n            `}).join('')}\n          </tbody>\n        </table>\n\n        <div class=\"footer\">\n          <p>This report was generated automatically by TeamBuilderz System</p>\n        </div>\n      </body>\n      </html>\n    `;\n  }\n\n  generateApplicationsHTML(data, options) {\n    const { applications = [], period } = data;\n    const statusGroups = applications.reduce((acc, app) => {\n      acc[app.status] = (acc[app.status] || 0) + 1;\n      return acc;\n    }, {});\n\n    return `\n      <!DOCTYPE html>\n      <html>\n      <head>\n        <meta charset=\"utf-8\">\n        <title>Applications Report</title>\n        <style>\n          body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; color: #333; }\n          .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #2563eb; padding-bottom: 20px; }\n          .header h1 { color: #2563eb; margin: 0; font-size: 28px; }\n          .status-overview { display: flex; justify-content: space-around; margin-bottom: 30px; }\n          .status-card { background: #f8fafc; padding: 15px; border-radius: 8px; text-align: center; min-width: 120px; }\n          .status-card h3 { margin: 0; color: #2563eb; font-size: 20px; }\n          .status-card p { margin: 5px 0; color: #666; font-size: 12px; }\n          table { width: 100%; border-collapse: collapse; margin-top: 20px; }\n          th, td { padding: 10px; text-align: left; border-bottom: 1px solid #e5e7eb; font-size: 12px; }\n          th { background: #f3f4f6; font-weight: 600; color: #374151; }\n          .status-sent { color: #3b82f6; }\n          .status-viewed { color: #8b5cf6; }\n          .status-shortlisted { color: #10b981; }\n          .status-interviewing { color: #f59e0b; }\n          .status-offered { color: #059669; }\n          .status-hired { color: #059669; font-weight: bold; }\n          .status-rejected { color: #dc2626; }\n          .footer { margin-top: 40px; text-align: center; color: #666; font-size: 12px; }\n        </style>\n      </head>\n      <body>\n        <div class=\"header\">\n          <h1>Applications Report</h1>\n          <p>TeamBuilderz LLC - Application Tracking</p>\n          <p>Period: ${period || 'All Time'} | Generated: ${new Date().toLocaleString()}</p>\n        </div>\n\n        <div class=\"status-overview\">\n          <div class=\"status-card\">\n            <h3>${statusGroups.sent || 0}</h3>\n            <p>Sent</p>\n          </div>\n          <div class=\"status-card\">\n            <h3>${statusGroups.viewed || 0}</h3>\n            <p>Viewed</p>\n          </div>\n          <div class=\"status-card\">\n            <h3>${statusGroups.shortlisted || 0}</h3>\n            <p>Shortlisted</p>\n          </div>\n          <div class=\"status-card\">\n            <h3>${statusGroups.interviewing || 0}</h3>\n            <p>Interviewing</p>\n          </div>\n          <div class=\"status-card\">\n            <h3>${statusGroups.offered || 0}</h3>\n            <p>Offered</p>\n          </div>\n          <div class=\"status-card\">\n            <h3>${statusGroups.hired || 0}</h3>\n            <p>Hired</p>\n          </div>\n        </div>\n\n        <table>\n          <thead>\n            <tr>\n              <th>Candidate</th>\n              <th>Company</th>\n              <th>Job Title</th>\n              <th>Status</th>\n              <th>Applied Date</th>\n              <th>Recruiter</th>\n              <th>Channel</th>\n            </tr>\n          </thead>\n          <tbody>\n            ${applications.map(app => `\n              <tr>\n                <td>${app.candidate_name || 'N/A'}</td>\n                <td>${app.company_name || 'N/A'}</td>\n                <td>${app.job_title || 'N/A'}</td>\n                <td class=\"status-${app.status}\">${app.status ? app.status.charAt(0).toUpperCase() + app.status.replace('_', ' ') : 'N/A'}</td>\n                <td>${app.applied_date ? new Date(app.applied_date).toLocaleDateString() : 'N/A'}</td>\n                <td>${app.recruiter_name || 'N/A'}</td>\n                <td>${app.channel || 'N/A'}</td>\n              </tr>\n            `).join('')}\n          </tbody>\n        </table>\n\n        <div class=\"footer\">\n          <p>Total Applications: ${applications.length} | This report was generated automatically by TeamBuilderz System</p>\n        </div>\n      </body>\n      </html>\n    `;\n  }\n\n  generateInterviewsHTML(data, options) {\n    const { interviews = [], period } = data;\n    const today = new Date();\n    const upcoming = interviews.filter(i => new Date(i.interview_date) > today).length;\n    const completed = interviews.filter(i => i.status === 'completed').length;\n    const pending = interviews.filter(i => i.status === 'scheduled').length;\n\n    return `\n      <!DOCTYPE html>\n      <html>\n      <head>\n        <meta charset=\"utf-8\">\n        <title>Interviews Report</title>\n        <style>\n          body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; color: #333; }\n          .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #2563eb; padding-bottom: 20px; }\n          .header h1 { color: #2563eb; margin: 0; font-size: 28px; }\n          .interview-stats { display: flex; justify-content: space-around; margin-bottom: 30px; }\n          .stat-card { background: #f8fafc; padding: 15px; border-radius: 8px; text-align: center; min-width: 120px; }\n          .stat-card h3 { margin: 0; color: #2563eb; font-size: 20px; }\n          .stat-card p { margin: 5px 0; color: #666; font-size: 12px; }\n          table { width: 100%; border-collapse: collapse; margin-top: 20px; }\n          th, td { padding: 10px; text-align: left; border-bottom: 1px solid #e5e7eb; font-size: 12px; }\n          th { background: #f3f4f6; font-weight: 600; color: #374151; }\n          .status-scheduled { color: #3b82f6; }\n          .status-completed { color: #059669; }\n          .status-feedback-pending { color: #f59e0b; }\n          .status-advanced { color: #10b981; }\n          .status-rejected { color: #dc2626; }\n          .footer { margin-top: 40px; text-align: center; color: #666; font-size: 12px; }\n        </style>\n      </head>\n      <body>\n        <div class=\"header\">\n          <h1>Interviews Report</h1>\n          <p>TeamBuilderz LLC - Interview Management</p>\n          <p>Period: ${period || 'All Time'} | Generated: ${new Date().toLocaleString()}</p>\n        </div>\n\n        <div class=\"interview-stats\">\n          <div class=\"stat-card\">\n            <h3>${upcoming}</h3>\n            <p>Upcoming</p>\n          </div>\n          <div class=\"stat-card\">\n            <h3>${completed}</h3>\n            <p>Completed</p>\n          </div>\n          <div class=\"stat-card\">\n            <h3>${pending}</h3>\n            <p>Pending Feedback</p>\n          </div>\n          <div class=\"stat-card\">\n            <h3>${interviews.length}</h3>\n            <p>Total Interviews</p>\n          </div>\n        </div>\n\n        <table>\n          <thead>\n            <tr>\n              <th>Candidate</th>\n              <th>Company</th>\n              <th>Type</th>\n              <th>Date</th>\n              <th>Time</th>\n              <th>Status</th>\n              <th>Recruiter</th>\n            </tr>\n          </thead>\n          <tbody>\n            ${interviews.map(interview => `\n              <tr>\n                <td>${interview.candidate_name || 'N/A'}</td>\n                <td>${interview.company_name || 'N/A'}</td>\n                <td>${interview.type ? interview.type.replace('_', ' ').charAt(0).toUpperCase() + interview.type.replace('_', ' ').slice(1) : 'N/A'}</td>\n                <td>${interview.interview_date ? new Date(interview.interview_date).toLocaleDateString() : 'N/A'}</td>\n                <td>${interview.interview_time || 'N/A'}</td>\n                <td class=\"status-${interview.status}\">${interview.status ? interview.status.charAt(0).toUpperCase() + interview.status.replace('_', ' ') : 'N/A'}</td>\n                <td>${interview.recruiter_name || 'N/A'}</td>\n              </tr>\n            `).join('')}\n          </tbody>\n        </table>\n\n        <div class=\"footer\">\n          <p>This report was generated automatically by TeamBuilderz System</p>\n        </div>\n      </body>\n      </html>\n    `;\n  }\n\n  generateGeneralHTML(data, options) {\n    return `\n      <!DOCTYPE html>\n      <html>\n      <head>\n        <meta charset=\"utf-8\">\n        <title>TeamBuilderz Report</title>\n        <style>\n          body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; color: #333; }\n          .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #2563eb; padding-bottom: 20px; }\n          .header h1 { color: #2563eb; margin: 0; font-size: 28px; }\n          .content { margin: 20px 0; }\n          .footer { margin-top: 40px; text-align: center; color: #666; font-size: 12px; }\n        </style>\n      </head>\n      <body>\n        <div class=\"header\">\n          <h1>TeamBuilderz Report</h1>\n          <p>Generated: ${new Date().toLocaleString()}</p>\n        </div>\n        <div class=\"content\">\n          <pre>${JSON.stringify(data, null, 2)}</pre>\n        </div>\n        <div class=\"footer\">\n          <p>This report was generated automatically by TeamBuilderz System</p>\n        </div>\n      </body>\n      </html>\n    `;\n  }\n}\n\nmodule.exports = new PDFService();
